## Agent Instance

You are part of pod: **steady-albatross** / Loop 0 / Agent 2 (Worker)

This identifier format is: Pod Name / Loop Number / Agent Number (Role).
- **Pod Name**: steady-albatross - persists for this entire Horizon session
- **Loop Number**: 0 - increments each time Horizon processes a new ticket
- **Agent**: Agent 2 (Worker) - your role in this loop

## Linear Team Configuration

**Team Key**: POLY

This team key is used for all Linear MCP tool calls. While you don't make Linear calls directly, this context may be passed to other agents.

---

## Context from Linear (gathered by Agent 1)

Claimed successfully. Here is the full context for Agent 2:

---

## Issue Details

- **Issue ID**: `b03bab6b-5f3b-42ac-a7e5-0bb7a144b691`
- **Identifier**: POLY-40
- **Title**: POLY-36c: Orchestrator Refactor — Stage-Aware Dispatch Loop
- **Status**: `∞ Validate In Progress` (just claimed)
- **Stage to Execute**: **validate**
- **Priority**: None set
- **Labels**: None
- **Project**: opus-hackathon
- **Branch**: `horizon/POLY-40`
- **URL**: https://linear.app/ogb/issue/POLY-40/poly-36c-orchestrator-refactor-stage-aware-dispatch-loop

## Description

Transform SandboxQueueProcessor from batch mode to continuous stage-aware dispatch loop.
Replace loadTasksFromQueue() with loadAllTasks() for nested feature_requests/ discovery.
Add filterEligible() with dependency resolution, isTerminal() for PR detection, branchName() for group-aware branching.
Add dispatchStage() with prompt loading, merge mode selection, and conditional test-writer.
Refactor processQueue() into continuous loop with bounded concurrency.
Update existing tests for new TaskRequest interface.
HIGHEST RISK sub-issue — modifies existing 310 LOC monolith.
See Sub-Issue 3 of the implementation plan.

**Estimated Scope**: ~400 LOC refactor + ~200 LOC test updates

**Dependencies**: Requires POLY-36a to be completed first.

**Plan Reference**: See horizon-docs/plans/2026-02-14-POLY-36-agent-pipeline-enhancement.md - Sub-Issue 3

⚠️ **HIGH RISK**: This refactor will break existing tests and modify the core orchestrator.

## Parent Issue

- **Identifier**: POLY-36
- **Title**: Agent Pipeline Enhancement
- **Status**: `∞ Needs Implement`
- **Project**: opus-hackathon
- Full description contains the entire pipeline architecture (5 phases, Spec Agent, ClaudeSpawner, PromptLoader, Orchestrator refactor, Test-Writer + Entry Point)

## Sibling Sub-Issues

| Identifier | Title | Status | Notes |
|---|---|---|---|
| POLY-38 | POLY-36a: Foundations — TaskStatus, PromptLoader, ClaudeSpawner | Done ✅ | Foundation dependency, completed |
| POLY-39 | POLY-36b: SpecAgent — Quality Gate + Ticket Writer | ∞ Awaiting Merge | Completed, waiting for human merge |
| **POLY-40** | POLY-36c: Orchestrator Refactor — Stage-Aware Dispatch Loop | **∞ Validate In Progress** | **THIS ISSUE — being validated now** |
| POLY-41 | POLY-36d: Test-Writer + Entry Point | ∞ Needs Implement | Blocked on POLY-39 + POLY-40 |

## Blocking/Blocked Relationships

- No formal Linear relations set, but per the parent issue description:
  - POLY-40 depends on POLY-38 (Done ✅)
  - POLY-41 depends on POLY-40 (this issue) — completing this unblocks POLY-41

## Previous Implementation Comments

The implementation was completed by **stellar-basilisk / Loop 1** in 478 seconds with 2 commits:

- `b984546`: feat(POLY-40) — Full SandboxQueueProcessor refactor (468 LOC)
- `af7b919`: docs(POLY-40) — Plan status update

### What was implemented (8 phases):

1. **Phase 3.1**: Updated TaskRequest interface — added `featureRequest`, `dependsOn`, `group`, `variantHint` fields; changed `status` to use TaskStatus enum
2. **Phase 3.2**: Task loading refactor — replaced `loadTasksFromQueue()` with `loadAllTasks()`, globs `feature_requests/FR-*/AGI-*.md` for nested discovery
3. **Phase 3.3**: Dependency resolution — added `filterEligible()` with dependency resolution (Done/Canceled = satisfied)
4. **Phase 3.4**: Terminal detection & branching — added `isTerminal()` for chain-end ticket detection, `branchName()` for group-aware branching (feat/{group} or feat/{id})
5. **Phase 3.5**: Stage dispatch orchestration — added `dispatchStage()` with prompt loading via PromptLoader, merge mode selection (auto/merge/pr), conditional test-writer invocation after implement stage
6. **Phase 3.6**: Continuous loop with bounded concurrency — refactored `processQueue()` into continuous loop with `Promise.race`, SIGINT/SIGTERM graceful shutdown, env config: NAPOLI_MAX_CONCURRENCY, NAPOLI_MAX_ITERATIONS, NAPOLI_POLL_INTERVAL, NAPOLI_MERGE_MODE
7. **Phase 3.7**: Test updates — updated `agent_logs.test.ts` (15 tests, 8 new loadAllTasks tests), new `orchestrator.test.ts` (13 tests for filterEligible, isTerminal, branchName, loadAllTasks)
8. **Phase 3.8**: Validation — all 101 unit tests pass, type check passes (npx tsc --noEmit), 4 pre-existing integration test failures (network/sandbox-dependent) unrelated to this change

## Validation Criteria

For the validate stage, Agent 2 should:

1. Verify the branch `horizon/POLY-40` exists and check it out
2. Run `npm test` — confirm all 101 unit tests pass (4 pre-existing integration failures are known/acceptable)
3. Run `npx tsc --noEmit` — confirm type checking passes
4. Review the key changed files for correctness:
   - `src/lib/SandboxQueueProcessor.ts` — the core refactor
   - `tests/orchestrator.test.ts` — new tests
   - `tests/agent_logs.test.ts` — updated tests
5. Verify the implementation matches the plan in `horizon-docs/plans/2026-02-14-POLY-36-agent-pipeline-enhancement.md` (Sub-Issue 3)
6. Confirm the refactor doesn't break the public API contract

## Artifacts / References

- **Branch**: `horizon/POLY-40`
- **Plan file**: `horizon-docs/plans/2026-02-14-POLY-36-agent-pipeline-enhancement.md`
- **Key commits**: `b984546`, `af7b919`

---

# Agent 2: Worker

You are the Worker agent. Agent 1 has already selected and claimed a Linear issue for you to work on. The issue context is provided above.

## First Step: Load Stage-Specific Instructions

Agent 1 has specified which stage to execute. **Read the detailed instructions for your stage before doing any work.**

| Stage | Instructions File |
|-------|-------------------|
| oneshot | `.horizon/prompts/agent2-worker-oneshot.md` |
| research | `.horizon/prompts/agent2-worker-research.md` |
| specification | `.horizon/prompts/agent2-worker-specification.md` |
| plan | `.horizon/prompts/agent2-worker-plan.md` |
| implement | `.horizon/prompts/agent2-worker-implement.md` |
| validate | `.horizon/prompts/agent2-worker-validate.md` |

**Read the file for your stage now, then follow those instructions exactly.**

## Quick Reference (details in stage-specific file)

### Branch Workflow
- You run in an isolated git worktree already on branch `horizon/{issue-identifier}`
- Never push directly to main; do NOT run `git checkout main`
- All merges happen via PR creation

### Output Format
All stages output a `WORK_RESULT` block. See your stage-specific file for the exact format.

## Important Notes

- You do NOT have access to Linear - don't try to update it
- All Linear context you need is provided above from Agent 1
- If something is unclear, make reasonable assumptions and note them
- If you encounter errors you can't fix, document them clearly

## Attachments

If the Linear issue has attachments (images, documents, etc.), they are automatically downloaded to:
```
.horizon/attachments/{issue-identifier}/
```

For example, attachments for issue F-69 would be in `.horizon/attachments/F-69/`. Check this folder if the issue description references attached files - you can read them directly from there instead of trying to fetch URLs.