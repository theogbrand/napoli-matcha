## Agent Instance

You are part of pod: **stellar-basilisk** / Loop 1 / Agent 2 (Worker)

This identifier format is: Pod Name / Loop Number / Agent Number (Role).
- **Pod Name**: stellar-basilisk - persists for this entire Horizon session
- **Loop Number**: 1 - increments each time Horizon processes a new ticket
- **Agent**: Agent 2 (Worker) - your role in this loop

## Linear Team Configuration

**Team Key**: POLY

This team key is used for all Linear MCP tool calls. While you don't make Linear calls directly, this context may be passed to other agents.

---

## Context from Linear (gathered by Agent 1)

Issue claimed successfully. Here is the full output for Agent 2:

---

## Issue for Agent 2

**Issue ID**: `b03bab6b-5f3b-42ac-a7e5-0bb7a144b691`
**Identifier**: POLY-40
**Title**: POLY-36c: Orchestrator Refactor — Stage-Aware Dispatch Loop
**Status**: ∞ Implement In Progress (just claimed)
**Stage to Execute**: **implement**
**Priority**: None set
**Labels**: None
**Project**: opus-hackathon

### Full Description

Transform SandboxQueueProcessor from batch mode to continuous stage-aware dispatch loop.
Replace loadTasksFromQueue() with loadAllTasks() for nested feature_requests/ discovery.
Add filterEligible() with dependency resolution, isTerminal() for PR detection, branchName() for group-aware branching.
Add dispatchStage() with prompt loading, merge mode selection, and conditional test-writer.
Refactor processQueue() into continuous loop with bounded concurrency.
Update existing tests for new TaskRequest interface.
HIGHEST RISK sub-issue — modifies existing 310 LOC monolith.
See Sub-Issue 3 of the implementation plan.

**Estimated Scope**: ~400 LOC refactor + ~200 LOC test updates

**Dependencies**: Requires POLY-36a to be completed first. (POLY-38 is Done — dependency satisfied.)

**Plan Reference**: See `horizon-docs/plans/2026-02-14-POLY-36-agent-pipeline-enhancement.md` - Sub-Issue 3

⚠️ **HIGH RISK**: This refactor will break existing tests and modify the core orchestrator.

### Parent Issue

**POLY-36**: Agent Pipeline Enhancement — the master plan for the entire agent pipeline refactoring. Contains the complete 5-phase architecture including:
- Phase 1: Spec Agent (done via POLY-39)
- Phase 2: ClaudeSpawner (done via POLY-38)
- Phase 3: Orchestrator refactor (**THIS ISSUE**)
- Phase 4: Entry Point (POLY-41, depends on this)
- Phase 5: Test-Writer subagent (POLY-41, depends on this)

The parent issue description contains the **complete architectural specification** including:
- `processQueue()` continuous loop with bounded concurrency
- `filterEligible()` with dependency resolution
- `isTerminal()` for chain-end ticket detection
- `branchName()` for group-aware branch naming
- `dispatchStage()` with conditional test-writer + merge agent
- `writeResults()` for MD file updates
- `stagePromptMap` for status-to-prompt routing
- `inProgressStatus()` helper
- `TaskRequest` interface update
- `TaskStatus` enum (already implemented in POLY-38)
- Configuration via environment variables (NAPOLI_MAX_CONCURRENCY, NAPOLI_MAX_ITERATIONS, NAPOLI_POLL_INTERVAL, NAPOLI_MERGE_MODE)

### Sibling Sub-Issues

1. **POLY-38** (POLY-36a: Foundations): **Done** — TaskStatus enum, PromptLoader, ClaudeSpawner, prompt files all implemented and merged. Branch: `horizon/POLY-38` (merged to main via PR #1).
2. **POLY-39** (POLY-36b: SpecAgent): **∞ Validate In Progress** — being validated by another agent (crystal-chimera). SpecAgent.ts (~170 LOC) and tests (15 tests) implemented on branch `horizon/POLY-39`. Commit: `de73c25`.
3. **POLY-40** (POLY-36c: Orchestrator Refactor): **THIS ISSUE** — ∞ Implement In Progress
4. **POLY-41** (POLY-36d: Test-Writer + Entry Point): **∞ Needs Implement** — blocked by POLY-39 and POLY-40

### Blocking/Blocked Relationships

- No formal Linear `blockedBy` relations set, but per the parent issue plan:
  - This issue depends on POLY-38 (Done ✓)
  - POLY-41 is blocked by this issue

### Branch Information

- **Git branch for this work**: `horizon/POLY-36` (the shared parent branch where all sub-issues build on)
- The current branch `horizon/POLY-36` has commits from POLY-38 (foundations) already merged, and POLY-39's work (commit `de73c25` — SpecAgent) is on branch `horizon/POLY-39`.

### Previous Comments on Parent (POLY-36)

1. **Research completed** (azure-falcon / Loop 0): Research document at `horizon-docs/research/2026-02-14-POLY-36-agent-pipeline-enhancement.md`
2. **Plan completed** (azure-falcon / Loop 1): Plan document at `horizon-docs/plans/2026-02-14-POLY-36-agent-pipeline-enhancement.md`, commit `0cb140a` on branch `horizon/POLY-36`. Created all 4 sub-issues.

### Key Implementation Details from the Plan

The core file to refactor is `src/lib/SandboxQueueProcessor.ts` (currently ~310 LOC). The refactor needs to:

1. **Replace `loadTasksFromQueue()`** with `loadAllTasks()` that globs `feature_requests/**/AGI-*.md`
2. **Add `filterEligible(allTasks, active)`** — filters for actionable tasks with satisfied dependencies
3. **Add `isTerminal(task)`** — checks if any non-Done task depends on this task
4. **Add `branchName(task)`** — returns `feat/{group}` or `feat/{id}`
5. **Add `dispatchStage(task, stagePrompt)`** — orchestrates one stage execution with conditional test-writer and merge agent
6. **Refactor `processQueue()`** into continuous loop with `Promise.race` for bounded concurrency
7. **Add `writeResults(task, result)`** — appends Results section to MD body
8. **Add `buildMergePrompt()`, `buildTestWriterPrompt()`** — prompt construction using PromptLoader
9. **Use `stagePromptMap`** from TaskStatus module for status-to-prompt routing
10. **Update `TaskRequest` interface** — add `featureRequest`, `dependsOn`, `group`, `variantHint`, `status` fields
11. **Update existing tests** for the new interface

### Environment Variable Configuration

| Env Var | Default | Description |
|---------|---------|-------------|
| `NAPOLI_MAX_CONCURRENCY` | `3` | Maximum parallel worker sandboxes |
| `NAPOLI_MAX_ITERATIONS` | `0` (infinite) | Total stage dispatches before exiting |
| `NAPOLI_POLL_INTERVAL` | `30` | Seconds to sleep when no tasks eligible |
| `NAPOLI_MERGE_MODE` | `auto` | Merge fragment selection: `auto`, `merge`, or `pr` |

---

# Agent 2: Worker

You are the Worker agent. Agent 1 has already selected and claimed a Linear issue for you to work on. The issue context is provided above.

## First Step: Load Stage-Specific Instructions

Agent 1 has specified which stage to execute. **Read the detailed instructions for your stage before doing any work.**

| Stage | Instructions File |
|-------|-------------------|
| oneshot | `.horizon/prompts/agent2-worker-oneshot.md` |
| research | `.horizon/prompts/agent2-worker-research.md` |
| specification | `.horizon/prompts/agent2-worker-specification.md` |
| plan | `.horizon/prompts/agent2-worker-plan.md` |
| implement | `.horizon/prompts/agent2-worker-implement.md` |
| validate | `.horizon/prompts/agent2-worker-validate.md` |

**Read the file for your stage now, then follow those instructions exactly.**

## Quick Reference (details in stage-specific file)

### Branch Workflow
- You run in an isolated git worktree already on branch `horizon/{issue-identifier}`
- Never push directly to main; do NOT run `git checkout main`
- All merges happen via PR creation

### Output Format
All stages output a `WORK_RESULT` block. See your stage-specific file for the exact format.

## Important Notes

- You do NOT have access to Linear - don't try to update it
- All Linear context you need is provided above from Agent 1
- If something is unclear, make reasonable assumptions and note them
- If you encounter errors you can't fix, document them clearly

## Attachments

If the Linear issue has attachments (images, documents, etc.), they are automatically downloaded to:
```
.horizon/attachments/{issue-identifier}/
```

For example, attachments for issue F-69 would be in `.horizon/attachments/F-69/`. Check this folder if the issue description references attached files - you can read them directly from there instead of trying to fetch URLs.